<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Tree Visualizer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cytoscape.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.21.1/cytoscape.min.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { width: 100%; height: 100%; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* Container Layering */
        #cy-container { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            background-color: #f8fafc; 
        }
        
        /* Canvas for Gen Labels (Background) */
        #bgCanvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 0; 
            pointer-events: none; 
        }
        
        /* Graph Layer (Foreground) */
        #cy { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 1; 
            background-color: transparent; 
        }
        
        .overlay-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .badge { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 4px; border: 1px solid rgba(0,0,0,0.1); }
        .bg-teal { background-color: #0d9488; }
        .bg-purple { background-color: #9333ea; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Clean Header (Title & Legend Only) -->
    <div class="absolute top-0 left-0 right-0 z-20 p-4 pointer-events-none flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
        <div class="pointer-events-auto overlay-card rounded-xl p-3 border border-slate-200 shadow-sm">
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-sitemap text-teal-600"></i> Family Tree
            </h1>
            <div class="text-xs text-slate-500 mt-1 flex flex-wrap gap-3">
                <span class="flex items-center"><span class="badge bg-teal"></span>Direct Descendant</span>
                <span class="flex items-center"><span class="badge bg-purple"></span>Married In</span>
            </div>
        </div>
        
        <!-- Reset View Button -->
        <button onclick="resetView()" class="pointer-events-auto overlay-card rounded-lg p-2 text-slate-500 hover:text-teal-600 shadow-sm" title="Reset View">
            <i class="fa-solid fa-compress-arrows-alt"></i>
        </button>
    </div>

    <!-- Info Panel (Details Only) -->
    <div id="infoPanel" class="absolute bottom-0 left-0 right-0 md:left-6 md:bottom-6 md:right-auto md:w-80 z-20 transform translate-y-full transition-transform duration-300 pointer-events-none">
        <div class="overlay-card md:rounded-2xl rounded-t-2xl p-5 border-t md:border border-slate-200 pointer-events-auto shadow-2xl">
            <div class="flex justify-between items-start mb-3">
                <h2 id="panelName" class="text-xl font-bold text-slate-800"></h2>
                <button onclick="closePanel()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <div id="panelDetails" class="text-sm text-slate-600 space-y-2"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="cy-container">
        <canvas id="bgCanvas"></canvas>
        <div id="cy"></div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        let currentSelectedNodeData = null;
        let cy = null;
        let generationBoundaries = [];

        // COMPACT LAYOUT SETTINGS
        const NODE_W = 120;
        const NODE_H = 45;
        const GAP_X = 15;        // Horizontal gap between nodes
        const GAP_Y = 15;        // Vertical gap between wrapped rows
        const GEN_MARGIN = 60;   // Margin between generation bands
        const START_X = 20;      // Fixed Left Margin
        const STACK_COLS = 4;
        const FAMILY_GAP = 30;

        // =========================================================================
        // --- DATA SECTION: PASTE YOUR FULL CSV CONTENT BETWEEN THE BACKTICKS ---
        // =========================================================================
        const embeddedCsvData = `ID,Name,Mother ID,Mother Name (Auto-fill),Father ID,Father Name (Auto-fill),Spouse ID,Spouse Name (Auto-Fill)
1.1,Sitacharan Dixit,,-,,-,1.2,Ratnamayee Devi
1.2,Ratnamayee Devi,,-,,-,1.1,Sitacharan Dixit
1.3,Munshi Param Pillai,,-,,-,1.2,Ratnamayee Devi
2.01,Saras,,-,,-,,
2.1,Sharada Mani Devi,1.2,Ratnamayee Devi,1.3,Munshi Param Pillai,,-
2.2,Kusum,,-,1.1,Sitacharan Dixit,2.51,Ramakant Tripathi
2.3,Satish Dixit,,-,1.1,Sitacharan Dixit,2.52,Renuka Dixit
2.4,Kumud Grover,,-,1.1,Sitacharan Dixit,2.53,Gulshan Grover
2.5,J N dixit,1.2,Ratnamayee Devi,1.3,Munshi Param Pillai,2.55,Annapurna Dixit
2.6,Narendrath Dixit,1.2,Ratnamayee Devi,1.3,Munshi Param Pillai,2.55,Annapurna Dixit
2.7,Sharad Dixit,1.2,Ratnamayee Devi,1.1,Sitacharan Dixit,2.56,Shakuntala Dixit (Apella/Gopa)
2.51,Ramakant Tripathi,,-,,-,2.2,Kusum
2.52,Renuka Dixit,,-,,-,2.3,Satish Dixit
2.53,Gulshan Grover,,-,,-,2.4,Kumud Grover
2.54,Vijayalakshmi Dixit,,-,,-,2.5,J N dixit
2.55,Annapurna Dixit,,-,,-,2.5,J N dixit
2.56,Shakuntala Dixit (Apella/Gopa),,-,,-,,-
2.57,Saras's spouse,,-,,-,,-
3.01,Neerja,2.01,Saras,2.57,Saras's spouse,,-
3.02,Avinash,2.01,Saras,2.57,Saras's spouse,,
3.03,Akhil,2.01,Saras,2.57,Saras's spouse,,
3.04,Amit,2.01,Saras,2.57,Saras's spouse,,
3.1,Shefali,2.2,Kusum,2.51,Ramakant Tripathi,,-
3.3,Jyothsna,2.2,Kusum,2.51,Ramakant Tripathi,,-
3.4,Archana,2.2,Kusum,2.51,Ramakant Tripathi,,-
3.5,Vandana,2.2,Kusum,2.51,Ramakant Tripathi,,-
3.6,Sanjay Dixit,2.52,Renuka Dixit,2.3,Satish Dixit,,-
3.7,Sandeep Dixit,2.52,Renuka Dixit,2.3,Satish Dixit,,-
3.8,Ulhas Grover,2.4,Kumud Grover,2.53,Gulshan Grover,,-
3.9,Chaitali Grover,2.4,Kumud Grover,2.53,Gulshan Grover,,-
3.11,Shailaja Dixit,2.55,Annapurna Dixit,2.6,Narendrath Dixit,,-
3.12,Yamini Dixit,2.55,Annapurna Dixit,2.6,Narendrath Dixit,,-
3.13,Karthik Dixit,2.56,Shakuntala Dixit (Apella/Gopa),2.7,Sharad Dixit,,-
3.14,Kaveri Dixit,2.56,Shakuntala Dixit (Apella/Gopa),2.7,Sharad Dixit,,-
3.15,Ashok,2.54,Vijayalakshmi Dixit,2.5,J N dixit,,-
3.16,Abha ,2.54,Vijayalakshmi Dixit,2.5,J N dixit,,-
3.17,Rahul,2.54,Vijayalakshmi Dixit,2.5,J N dixit,,-
3.18,Deepa,2.54,Vijayalakshmi Dixit,2.5,J N dixit,,-
3.19,Dhruv,2.54,Vijayalakshmi Dixit,2.5,J N dixit,,-
3.51,Dinesh,,-,,-,3.1,Shefali
3.52,Vijay,,-,,-,3.3,Jyothsna
3.54,Umakant,,-,,-,3.4,Archana
3.56,Kavita Dixit,,-,,-,3.6,Sanjay Dixit
3.57,Radhika Dixit,,-,,-,3.7,Sandeep Dixit
3.58,Shucha Grover,,-,,-,3.8,Ulhas Grover
3.511,Sridharan Ranganathan,,-,,-,3.11,Shailaja Dixit
3.512,Porus Antia,,-,,-,3.12,Yamini Dixit
3.513,Jiya Minocha,,-,,-,3.13,Karthik Dixit
3.514,Subbu,,-,,-,3.14,Kaveri Dixit
3.515,Sangamitra,,-,,-,3.15,Ashok
3.517,Rupa Thakur,,-,,-,3.17,Rahul
4.41,Anurag Upadhyay,3.4,Archana,3.54,Umakant,,-
4.11,Shibani,3.1,Shefali,3.51,Dinesh,,-
4.61,Pallavi Dixit,3.56,Kavita Dixit,3.6,Sanjay Dixit,,
4.62,Manavi Dixit,3.56,Kavita Dixit,3.6,Sanjay Dixit,,
4.71,Nataasha Dixit,3.57,Radhika Dixit,3.7,Sandeep Dixit,,-
4.81,Neel Grover,3.58,Shucha Grover,3.8,Ulhas Grover,,-
4.91,Tanay,3.9,Chaitali Grover,,-,,-
4.111,Advait D Ranganathan,3.11,Shailaja Dixit,3.511,Sridharan Ranganathan,,-
4.112,Vedant D Ranganathan,3.11,Shailaja Dixit,3.511,Sridharan Ranganathan,,-
4.121,Sanaa Dixit Antia,3.12,Yamini Dixit,3.512,Porus Antia,,-
4.122,Reyah Antia Dixit,3.12,Yamini Dixit,3.512,Porus Antia,,-`;
        // =========================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initCytoscape();
            // Load from embedded CSV immediately
            processCSV(embeddedCsvData);

            window.addEventListener('resize', () => {
                resizeCanvas();
                drawBackgroundLines();
            });
            resizeCanvas();
        });

        // --- 3. CYTOSCAPE SETUP ---
        function initCytoscape() {
            cy = cytoscape({
                container: document.getElementById('cy'),
                boxSelectionEnabled: false,
                autounselectify: true,
                autoungrabify: true, // DISABLE NODE DRAGGING
                wheelSensitivity: 0.2,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'content': 'data(label)',
                            'text-valign': 'center', 'text-halign': 'center',
                            'background-color': '#ffffff',
                            'border-width': 2, 'border-color': '#0d9488', // Teal
                            'color': '#334155', 'font-size': '11px', 'font-weight': '600',
                            'width': 'label', 'height': NODE_H, 'padding': '6px',
                            'shape': 'round-rectangle', 'text-wrap': 'wrap', 'text-max-width': '90px'
                        }
                    },
                    {
                        selector: 'node[type="married-in"]',
                        style: {
                            'background-color': '#faf5ff', 
                            'border-color': '#9333ea', 
                            'color': '#581c87'
                        }
                    },
                    {
                        selector: 'edge', // Hidden by default
                        style: { 'width': 2, 'curve-style': 'bezier', 'opacity': 0 }
                    },
                    // Highlight Styles
                    {
                        selector: 'node.highlighted',
                        style: { 'background-color': '#ccfbf1', 'border-width': 4, 'z-index': 999 }
                    },
                    {
                        selector: 'node.highlighted[type="married-in"]',
                        style: { 'background-color': '#f3e8ff' }
                    },
                    {
                        selector: 'edge.highlighted',
                        style: { 'opacity': 1, 'width': 3, 'z-index': 998 }
                    },
                    {
                        selector: 'edge.highlighted[type="child"]',
                        style: { 'line-color': '#3b82f6', 'target-arrow-shape': 'triangle', 'target-arrow-color': '#3b82f6' }
                    },
                    {
                        selector: 'edge.highlighted[type="spouse"]',
                        style: { 'line-color': '#ef4444', 'line-style': 'dashed' }
                    },
                    { selector: '.faded', style: { 'opacity': 0.1 } }
                ]
            });

            cy.on('tap', 'node', (evt) => {
                showDetails(evt.target);
                highlightTrace(evt.target);
            });
            cy.on('tap', (evt) => {
                if(evt.target === cy) { closePanel(); resetHighlights(); }
            });
            cy.on('render pan zoom', () => requestAnimationFrame(drawBackgroundLines));
        }

        // --- 4. DATA LOGIC ---
        function processCSV(csv) {
            Papa.parse(csv, {
                header: true, skipEmptyLines: true,
                complete: (res) => {
                    buildGraph(res.data);
                }
            });
        }

        function isMarriedIn(id) {
            const parts = id.split('.');
            if(parts.length > 1) {
                const s = parts[1];
                if(s.startsWith('5') && s !== '5') return true;
            }
            return false;
        }

        function buildGraph(data) {
            cy.elements().remove();
            generationBoundaries = [];
            const rawNodes = [];
            const ids = new Set();

            // 1. Ingest
            data.forEach(row => {
                const id = row['ID'] || row['id']; 
                const name = row['Name'] || row['name'];
                if(id && name) {
                    const idStr = id.toString().trim();
                    let gen = 1;
                    const m = idStr.match(/^(\d+)/);
                    if(m) gen = parseInt(m[1]);
                    
                    rawNodes.push({
                        id: idStr, label: name.toString().trim(), gen, raw: row,
                        fatherId: (row['Father ID']||'').trim(),
                        motherId: (row['Mother ID']||'').trim(),
                        spouseId: (row['Spouse ID']||'').trim(),
                        type: isMarriedIn(idStr) ? 'married-in' : 'descendant'
                    });
                    ids.add(idStr);
                }
            });

            if(rawNodes.length === 0) return;

            // 2. Fix Generations
            const nodeMap = new Map();
            rawNodes.forEach(n => nodeMap.set(n.id, n));
            for(let i=0; i<10; i++) {
                let changed = false;
                rawNodes.forEach(n => {
                    let maxP = 0;
                    if(n.fatherId && nodeMap.has(n.fatherId)) maxP = Math.max(maxP, nodeMap.get(n.fatherId).gen);
                    if(n.motherId && nodeMap.has(n.motherId)) maxP = Math.max(maxP, nodeMap.get(n.motherId).gen);
                    
                    if(maxP > 0 && n.gen <= maxP) { 
                        n.gen = maxP + 1; 
                        changed = true; 
                    }
                    
                    if(n.spouseId && nodeMap.has(n.spouseId)) {
                        const s = nodeMap.get(n.spouseId);
                        if(s.gen !== n.gen) {
                            const t = Math.max(s.gen, n.gen);
                            n.gen = t; s.gen = t; changed = true;
                        }
                    }
                });
                if(!changed) break;
            }

            // 3. LAYOUT: Left-Aligned Grid
            const gens = new Map();
            rawNodes.forEach(n => {
                if(!gens.has(n.gen)) gens.set(n.gen, []);
                gens.get(n.gen).push(n);
            });

            const positions = new Map();
            const sortedGens = Array.from(gens.keys()).sort((a,b)=>a-b);
            let currentGenY = 50;

            sortedGens.forEach(gen => {
                const nodes = gens.get(gen);
                
                // Sort nodes
                nodes.sort((a,b) => {
                    const getPX = (n) => {
                        let sum = 0, count = 0;
                        [n.fatherId, n.motherId].forEach(pid => {
                            if(pid && positions.has(pid)) { sum += positions.get(pid).x; count++; }
                        });
                        return count ? sum/count : 0;
                    };
                    const pa = getPX(a);
                    const pb = getPX(b);
                    if (Math.abs(pa - pb) > 1) return pa - pb;
                    return a.id.localeCompare(b.id); 
                });

                const WRAP_LIMIT = 6; 
                let cursorX = START_X;
                let currentRow = 0;

                nodes.forEach((n, idx) => {
                    if(idx > 0 && idx % WRAP_LIMIT === 0) {
                        currentRow++;
                        cursorX = START_X;
                    }

                    positions.set(n.id, {
                        x: cursorX,
                        y: currentGenY + (currentRow * (NODE_H + GAP_Y))
                    });

                    cursorX += NODE_W + GAP_X;
                });

                const genHeight = (currentRow + 1) * (NODE_H + GAP_Y) + GEN_MARGIN;
                
                generationBoundaries.push({
                    gen: gen,
                    y: currentGenY - (GEN_MARGIN/3)
                });

                currentGenY += genHeight;
            });

            // 4. Add to Graph
            const cyNodes = [];
            const cyEdges = [];
            const edgeKeys = new Set();

            rawNodes.forEach(n => {
                const pos = positions.get(n.id) || {x:0, y:0};
                cyNodes.push({ data: {...n}, position: pos });

                const addE = (s, t, type) => {
                    const k = [s,t].sort().join('-');
                    if(!edgeKeys.has(k) && ids.has(s) && ids.has(t)) {
                        edgeKeys.add(k);
                        cyEdges.push({ data: { source: s, target: t, type } });
                    }
                }
                if(n.fatherId) addE(n.fatherId, n.id, 'child');
                if(n.motherId) addE(n.motherId, n.id, 'child');
                if(n.spouseId) addE(n.id, n.spouseId, 'spouse');
            });

            cy.add(cyNodes);
            cy.add(cyEdges);
            
            // IMPORTANT: Force Layout & Zoom
            cy.layout({ name: 'preset' }).run();
            setTimeout(() => {
                cy.fit(50);
                alignLeft();
                drawBackgroundLines();
            }, 100);
        }

        function alignLeft() {
            const zoom = cy.zoom();
            const bb = cy.elements().boundingBox();
            if(bb.w === 0) return; 
            const panX = START_X + 20 - (bb.x1 * zoom);
            const panY = 50 - (bb.y1 * zoom);
            cy.pan({ x: panX, y: panY });
        }

        // --- Interaction ---
        function highlightTrace(node) {
            cy.elements().removeClass('highlighted faded');
            
            const ancestors = node.predecessors('node, edge[type="child"]');
            const descendants = node.successors('node, edge[type="child"]');
            const lineage = node.union(ancestors.nodes()).union(descendants.nodes());
            const spouses = lineage.connectedEdges('edge[type="spouse"]').connectedNodes();
            const group = lineage.union(spouses);
            const edges = group.connectedEdges().filter(e => group.contains(e.source()) && group.contains(e.target()));

            cy.elements().addClass('faded');
            group.union(edges).removeClass('faded').addClass('highlighted');
        }

        function resetHighlights() { cy.elements().removeClass('highlighted faded'); }

        function showDetails(node) {
            const d = node.data('raw');
            const p = document.getElementById('infoPanel');
            document.getElementById('panelName').innerText = d.Name || d.name;
            
            let h = `<div class="grid grid-cols-1 gap-2">`;
            const fn = d['Father Name (Auto-fill)'] || d['Father Name'];
            const mn = d['Mother Name (Auto-fill)'] || d['Mother Name'];
            const sn = d['Spouse Name (Auto-Fill)'] || d['Spouse NAme (Auto-Fill)'] || d['Spouse Name'];
            
            if(fn && fn !== '-') h += `<div class="text-xs"><b class="text-blue-600">FATHER:</b> ${fn}</div>`;
            if(mn && mn !== '-') h += `<div class="text-xs"><b class="text-blue-600">MOTHER:</b> ${mn}</div>`;
            if(sn && sn !== '-') h += `<div class="text-xs"><b class="text-red-600">SPOUSE:</b> ${sn}</div>`;
            h += `</div>`;
            document.getElementById('panelDetails').innerHTML = h;
            
            p.classList.remove('translate-y-full');
        }

        function closePanel() { document.getElementById('infoPanel').classList.add('translate-y-full'); }

        function focusNode(id) {
            const n = cy.$id(id);
            if(n.length) {
                cy.animate({ fit: { eles: n, padding: 100 }, duration: 500 });
                showDetails(n);
                highlightTrace(n);
            }
        }

        // --- Visuals ---
        function resizeCanvas() {
            const c = document.getElementById('bgCanvas');
            c.width = document.getElementById('cy-container').offsetWidth;
            c.height = document.getElementById('cy-container').offsetHeight;
        }

        function drawBackgroundLines() {
            const c = document.getElementById('bgCanvas');
            const ctx = c.getContext('2d');
            ctx.clearRect(0,0,c.width,c.height);
            if(!cy || !generationBoundaries.length) return;
            
            const pan = cy.pan();
            const zoom = cy.zoom();
            
            ctx.save();
            ctx.strokeStyle = '#cbd5e1'; 
            ctx.fillStyle = '#64748b';
            ctx.font = 'bold 12px sans-serif';
            ctx.setLineDash([4,4]);

            generationBoundaries.forEach((b, i) => {
                const y = b.y * zoom + pan.y;
                if(i > 0) {
                    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(c.width, y); ctx.stroke();
                }
                ctx.fillText(`GEN ${b.gen}`, 20, y + 20);
            });
            ctx.restore();
        }

        function resetView() { alignLeft(); resetHighlights(); closePanel(); }
    </script>
</body>
</html>